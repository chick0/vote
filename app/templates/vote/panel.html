{% extends 'layout.html' %}
{% block content %}
<section class="section">
    <div class="container">
        <h1 class="title is-1">{{ title }}</h1>
    {% if error != none %}
        <div class="notification is-danger">
            {{ error }}
        </div>
    {% endif %}

        <div class="columns">
            <div class="column">
                <img id="qrcode" class="image" src="{{ url_for('qrcode.join', vote_id=id) }}">
            </div>
            <div class="column">
                <div class="box" style="font-size:1.3rem;">
                    <p>최대 참여인원 : <b>{{ max }}</b>명</p>
                    <p>투표 참여인원 : <b id="total">-</b>명</p>
                </div>
                <div class="box" style="font-size:1.3rem;">
                    <p>투표 완료인원 : <b id="selected">-</b>명</p>
                    <p>투표 참여율 : <b id="per">-</b>%</p>
                </div>
                <button class="button is-info is-light is-large is-fullwidth copy" data-clipboard-text="{{ join_url }}">링크 복사하기</button>
            </div>
        </div>
    </div>
</section>

<section class="section">
    <div class="container">
        <h2 class="title is-2">투표 선택지</h2>
        <div class="block">
            <button id="add_option" class="button is-info is-light is-large">선택지 추가</button>
        </div>

        <div class="block" id="display"></div>
    </div>
</section>

<section class="section">
    <div class="container">
        <button id="vote_start" class="button is-info is-large is-fullwidth">투표 시작</button>
        <button id="vote_end" class="button is-dark is-large is-fullwidth">투표 결과 확인</button>
    </div>
</section>
{% endblock %}

{% block script %}
<script src="{{ url_for('static', filename='js/clipboard.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/sweetalert2.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/status.js') }}"></script>
<script src="{{ url_for('static', filename='js/options.js') }}"></script>
<script>
    const vote_id = {{ id }};
    const result_url = "{{ url_for('result.panel', vote_id=id) }}";
    const clipboard = new ClipboardJS(".copy");
    let opts = JSON.parse(`{{ opts|safe }}`);

    clipboard.on("success", (e) => {
        e.clearSelection();
        Swal.fire({
            icon: "info",
            text: "복사되었습니다!",
            showCancelButton: false,
            showConfirmButton: true,
            confirmButtonText: "닫기",
            timer: 2022,
            timerProgressBar: true
        });
    });

    document.getElementById("qrcode").addEventListener("click", () => {
        window.open("{{ url_for('qrcode.join', vote_id=id) }}");
    });

    document.getElementById("add_option").addEventListener("click", () => {
        Swal.fire({
            icon: "info",
            title: "새로운 선택지를 입력해주세요.",
            input: "text",
        }).then((result) => {
            if(result.isConfirmed) {
                create_option(result.value);
            }
        });
    });

    document.getElementById("vote_start").addEventListener("click", () => start_vote());
    document.getElementById("vote_end").addEventListener("click", () => {
        Swal.fire({
            icon: "question",
            text: "투표를 마감하고 결과를 확인하시겠습니까?",
            showCancelButton: true,
            showConfirmButton: true,
            confirmButtonText: "네",
            cancelButtonText: "아니요",
        }).then((result) => {
            if(result.isConfirmed) {
                location.href = result_url;
            } else {
                Swal.fire({
                    icon: "warning",
                    text: "취소되었습니다.",
                    showConfirmButton: true,
                    confirmButtonText: "닫기",
                    timer: 2022,
                    timerProgressBar: true
                });
            }
        });
    });

    window.onload = () => {
        render_display();
        update_status();
        setInterval(update_status, 5000);
        if({{ started|lower }} == true){
            document.getElementById("vote_start").classList.add("is-hidden");
        } else {
            document.getElementById("vote_end").classList.add("is-hidden");
        }
    };
</script>
{% endblock %}